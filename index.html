<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>RÃ©visions CE1 âœ CE2 â€“ AdÃ¨le</title>
<style>
  :root{
    --bg:#fffaf4; --card:#ffffff; --ink:#263238; --muted:#607d8b;
    --pri:#4caf50; --pri-weak:#e8f5e9; --sec:#ff8a65; --sec-weak:#fff3e9; --acc:#42a5f5; --acc-weak:#e3f2fd;
    --warn:#ffb300; --err:#e53935; --ok:#2e7d32; --radius:14px; --shadow:0 10px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0; color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
    background:
      radial-gradient(1000px 1000px at 10% -10%, var(--acc-weak), transparent 50%),
      radial-gradient(800px 800px at 110% 0%, var(--sec-weak), transparent 40%),
      var(--bg);
    -webkit-tap-highlight-color: transparent;
  }
  header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.1) blur(8px);
    background:linear-gradient(#ffffffcc,#ffffffcc); border-bottom:1px solid #eee;}
  .bar{max-width:1100px; margin:auto; padding:10px 16px; display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .logo{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px; font-size:18px}
  .logo-badge{width:36px; height:36px; border-radius:50%; display:grid; place-items:center;
    background:conic-gradient(from 90deg,var(--pri),var(--acc),var(--sec)); color:white; font-weight:900; box-shadow:var(--shadow)}
  nav{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
  .tab-btn{border:1px solid #dde4ea; background:#fff; color:#34495e; padding:8px 12px; border-radius:999px; cursor:pointer; transition:.2s; font-weight:600}
  .tab-btn.active{background:var(--pri); border-color:var(--pri); color:white}
  .pill{background:var(--acc-weak); color:#0b5cab; border:none}
  .name-edit{display:flex; align-items:center; gap:8px; background:#fff; border:1px solid #dde4ea; border-radius:999px; padding:6px 10px}
  .name-edit input{border:none; outline:none; min-width:120px; font-weight:700}
  main{max-width:1100px; margin:22px auto; padding:0 16px 100px}
  .screen{display:none} .screen.active{display:block; animation:fade .25s ease}
  @keyframes fade{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:none}}
  .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:16px}
  .card{background:var(--card); border:1px solid #edf1f5; border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; display:flex; flex-direction:column; gap:12px}
  .card h3{margin:0; font-size:18px}
  .muted{color:var(--muted)} .btn{display:inline-flex; align-items:center; gap:8px; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700; background:var(--pri); color:#fff; box-shadow:var(--shadow)}
  .btn.secondary{background:var(--acc)} .btn.ghost{background:#fff; color:#34495e; border:1px solid #dde4ea}
  .btn.warn{background:var(--warn); color:#1a1a1a} .btn.danger{background:var(--err)}
  .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center} .grow{flex:1} .badge{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:var(--pri-weak); color:var(--ok); font-weight:700}
  input[type="number"], input[type="text"], select, textarea{width:100%; padding:12px; border-radius:10px; border:1px solid #dde4ea; outline:none; font-size:16px}
  .q{background:linear-gradient(0deg,#fff,#fff) padding-box, conic-gradient(from 180deg at 0 0, var(--acc), var(--pri), var(--sec), var(--acc)) border-box; border:2px solid transparent; border-radius:16px; padding:14px}
  .q .title{font-weight:800; margin-bottom:8px}
  .choices{display:grid; gap:8px; margin:10px 0}
  .choice{border:1px solid #dde4ea; border-radius:12px; padding:12px; cursor:pointer; background:#fff; user-select:none}
  .choice.correct{border-color:#2e7d32; background:#e8f5e9} .choice.wrong{border-color:#e53935; background:#ffebee}
  .xpbar{height:10px; border-radius:999px; background:#edf2f7; overflow:hidden} .xpbar>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--acc),var(--pri)); transition:width .3s}
  .toggle{width:52px; height:30px; border-radius:999px; background:#e9eef3; position:relative; cursor:pointer; border:1px solid #d6dee6}
  .toggle i{position:absolute; width:26px; height:26px; background:#fff; border-radius:50%; top:1px; left:1px; box-shadow:var(--shadow); transition:.2s}
  .toggle.on{background:#c8e6c9; border-color:#c8e6c9} .toggle.on i{left:25px}
  .lesson{background:#fff; border:1px solid #e8eef4; border-radius:12px; padding:12px} .lesson h4{margin:.2rem 0}
  .footnote{font-size:12px; color:#78909c} .speak{background:#fff; border:1px dashed #d7e3f0; padding:8px 10px; border-radius:10px; color:#0b5cab; cursor:pointer}
  .kudos{display:flex; gap:6px} .kudos i{width:22px; height:22px; display:grid; place-items:center; background:#fff; border:1px solid #e5ebf1; border-radius:6px}
  .progress{height:8px; border-radius:999px; background:#edf2f7; overflow:hidden} .progress>i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--sec),var(--acc)); transition:width .2s}
  @media (max-width:480px){ .name-edit{width:100%} nav{width:100%} }
</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">
      <div class="logo-badge" aria-hidden="true">A</div>
      <div>
        RÃ©visions CE1 âœ CE2
        <div class="footnote">FranÃ§ais â€¢ Maths â€¢ ProblÃ¨mes â€¢ PrÃ©pa CE2</div>
      </div>
    </div>

    <div class="name-edit">
      ğŸ‘§ <input id="childName" value="AdÃ¨le" aria-label="PrÃ©nom de l'enfant"/>
      <button class="btn ghost" id="saveName">Enregistrer</button>
      <button class="speak" id="speakConsigne">ğŸ”Š Lire la consigne</button>
    </div>

    <nav>
      <button class="tab-btn active" data-tab="dash">Tableau de bord</button>
      <button class="tab-btn" data-tab="fr">FranÃ§ais</button>
      <button class="tab-btn" data-tab="maths">Maths</button>
      <button class="tab-btn pill" data-tab="lessons">LeÃ§ons</button>
      <button class="tab-btn" data-tab="ce2">PrÃ©pa CE2</button>
    </nav>
  </div>
</header>

<main>
  <!-- DASHBOARD -->
  <section id="dash" class="screen active">
    <div class="cards">
      <div class="card">
        <h3>Bravo, <span id="helloName">AdÃ¨le</span> !</h3>
        <div>Voici tes progrÃ¨s. Fais un peu chaque jour ğŸ†</div>
        <div class="row">
          <div class="grow">
            <div class="muted">Progression globale</div>
            <div class="xpbar"><i id="xpbar"></i></div>
            <div class="footnote"><span id="xpText">0</span> / 100 XP</div>
          </div>
          <div class="kudos" id="kudos"></div>
        </div>
        <div class="row">
          <button class="btn" data-tab-jump="fr">Commencer en FranÃ§ais ğŸ“š</button>
          <button class="btn secondary" data-tab-jump="maths">Aller en Maths â—</button>
          <button class="btn ghost" data-tab-jump="ce2">PrÃ©pa Ã‰valuations CE2 ğŸ“</button>
          <button class="btn ghost" id="resetProgress">ğŸ” RÃ©initialiser les progrÃ¨s</button>
        </div>
      </div>

      <div class="card">
        <h3>Conseil du jour</h3>
        <div id="tip" class="muted">Lis la consigne deux fois, puis touche le bouton ğŸ”Š pour lâ€™entendre.</div>
        <div class="row">
          <div class="muted">Mode lecture automatique</div>
          <div class="toggle" id="autoRead"><i></i></div>
        </div>
      </div>

      <div class="card">
        <h3>Parents ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</h3>
        <div class="row">
          <div class="grow">
            <div class="muted">Progression par matiÃ¨re</div>
            <ul id="statsList" class="muted"></ul>
          </div>
          <div class="grow">
            <div class="muted">DerniÃ¨res activitÃ©s</div>
            <ul id="activityLog" class="muted"></ul>
            <button class="btn ghost" id="downloadReport">â¬‡ï¸ Exporter le rapport (.json)</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- FRANÃ‡AIS -->
  <section id="fr" class="screen">
    <div class="cards">
      <!-- Conjugaison -->
      <div class="card">
        <h3>Conjugaison â€“ PrÃ©sent de lâ€™indicatif</h3>
        <div class="muted">Verbes CE1 (1er groupe + Ãªtre/avoir/aller/faire). Ã‰cris la bonne forme.</div>
        <div class="row">
          <label class="muted">Verbe : </label>
          <select id="verbSelect"></select>
          <label class="muted">Sujet : </label>
          <select id="subjectSelect"></select>
          <button class="btn" id="newConj">Nouvelle question</button>
        </div>
        <div class="q" id="conjBox" aria-live="polite">
          <div class="title" id="conjPrompt">â€”</div>
          <div class="row">
            <input id="conjAnswer" type="text" placeholder="RÃ©ponse iciâ€¦" autocomplete="off" />
            <button class="btn" id="checkConj">VÃ©rifier</button>
          </div>
          <div class="row">
            <button class="btn ghost" id="conjHint">ğŸ’¡ Indice</button>
            <span id="conjFeedback" class="muted"></span>
          </div>
        </div>
      </div>

      <!-- ComprÃ©hension -->
      <div class="card">
        <h3>ComprÃ©hension de texte</h3>
        <div class="muted">Lis le petit texte puis rÃ©ponds aux 3 questions.</div>
        <div class="q">
          <div class="lesson" id="readingText">â€”</div>
          <div class="choices" id="readingChoices"></div>
          <div class="row">
            <button class="btn" id="newReading">Nouveau texte</button>
            <button class="btn ghost" id="readingHint">ğŸ’¡ Relire un passage</button>
            <span id="readingFeedback" class="muted"></span>
          </div>
        </div>
      </div>

      <!-- Orthographe courte -->
      <div class="card">
        <h3>Orthographe â€“ Accords simples</h3>
        <div class="muted">Choisis la bonne Ã©criture.</div>
        <div class="q">
          <div class="title" id="orthoPrompt">â€”</div>
          <div id="orthoChoices" class="choices"></div>
          <div class="row">
            <button class="btn" id="newOrtho">Nouvelle phrase</button>
            <span id="orthoFeedback" class="muted"></span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- MATHS -->
  <section id="maths" class="screen">
    <div class="cards">

      <!-- OpÃ©rations -->
      <div class="card">
        <h3>OpÃ©rations rapides</h3>
        <div class="muted">Additions et soustractions (0â€“99). Mode â€œretenueâ€ ajustÃ© automatiquement.</div>
        <div class="row">
          <select id="opType">
            <option value="+">Addition</option>
            <option value="-">Soustraction</option>
          </select>
          <label class="muted">Niveau :</label>
          <select id="level">
            <option value="1">Facile (0â€“20)</option>
            <option value="2">Normal (0â€“50)</option>
            <option value="3">CE1 max (0â€“99)</option>
          </select>
          <button class="btn" id="newOp">Nouvelle opÃ©ration</button>
        </div>
        <div class="q">
          <div class="title" id="opPrompt">â€”</div>
          <div class="row">
            <input id="opAnswer" type="number" inputmode="numeric" placeholder="?" />
            <button class="btn" id="checkOp">VÃ©rifier</button>
            <button class="btn ghost" id="opHint">ğŸ’¡ Indice</button>
          </div>
          <div id="opFeedback" class="muted"></div>
        </div>
      </div>

      <!-- ProblÃ¨mes -->
      <div class="card">
        <h3>RÃ©solution de problÃ¨mes</h3>
        <div class="muted">Lis, choisis lâ€™opÃ©ration, puis calcule. Lâ€™explication te guide pas Ã  pas.</div>
        <div class="q">
          <div class="title" id="pbText">â€”</div>
          <div class="row">
            <select id="pbOpChoice">
              <option value="">Choisis lâ€™opÃ©ration</option>
              <option value="+">Addition</option>
              <option value="-">Soustraction</option>
            </select>
            <input id="pbAnswer" type="number" placeholder="RÃ©sultat" />
            <button class="btn" id="checkPb">VÃ©rifier</button>
            <button class="btn ghost" id="pbHint">ğŸ’¡ Indice</button>
          </div>
          <div id="pbSteps" class="lesson muted"></div>
        </div>
        <div class="row">
          <button class="btn secondary" id="newPb">Nouveau problÃ¨me</button>
        </div>
      </div>

    </div>
  </section>

  <!-- LEÃ‡ONS -->
  <section id="lessons" class="screen">
    <div class="cards">
      <div class="card">
        <h3>LeÃ§ons â€“ FranÃ§ais</h3>
        <div class="row"><div class="lesson grow">
          <h4>PrÃ©sent â€“ 1er groupe (-er)</h4>
          <ul class="muted">
            <li>Je <b>parle</b>, tu <b>parles</b>, il/elle <b>parle</b></li>
            <li>Nous <b>parlons</b>, vous <b>parlez</b>, ils/elles <b>parlent</b></li>
            <li>âš ï¸ Pas de â€œ-sâ€ Ã  <i>je</i> : je parle</li>
          </ul>
        </div>
        <div class="lesson grow">
          <h4>ÃŠtre / Avoir / Aller / Faire</h4>
          <div class="muted">
            Ãªtre: je <b>suis</b>, tu <b>es</b>, il <b>est</b>, nous <b>sommes</b>, vous <b>Ãªtes</b>, ils <b>sont</b><br/>
            avoir: jâ€™<b>ai</b>, tu <b>as</b>, il <b>a</b>, nous <b>avons</b>, vous <b>avez</b>, ils <b>ont</b><br/>
            aller: je <b>vais</b>, tu <b>vas</b>, il <b>va</b>, nous <b>allons</b>, vous <b>allez</b>, ils <b>vont</b><br/>
            faire: je <b>fais</b>, tu <b>fais</b>, il <b>fait</b>, nous <b>faisons</b>, vous <b>faites</b>, ils <b>font</b>
          </div>
        </div></div>
        <div class="row"><div class="lesson grow">
          <h4>Futur proche</h4>
          <div class="muted">aller + infinitif : <i>je vais jouer</i>, <i>nous allons lire</i>.</div>
        </div>
        <div class="lesson grow">
          <h4>Accords simples</h4>
          <div class="muted"><b>Le</b> chat noir / <b>Les</b> chats noir<b>s</b>. â€“ <b>La</b> robe rouge / <b>Les</b> robes rouge<b>s</b>.</div>
        </div></div>
      </div>

      <div class="card">
        <h3>LeÃ§ons â€“ Maths</h3>
        <div class="row"><div class="lesson grow">
          <h4>Addition posÃ©e</h4>
          <div class="muted">Aligne unitÃ©s, dizaines. Commence par la droite. Si â‰¥ 10, Ã©cris lâ€™unitÃ© et mets la dizaine en retenue.</div>
        </div>
        <div class="lesson grow">
          <h4>Soustraction posÃ©e</h4>
          <div class="muted">Si tu ne peux pas, emprunte 1 dizaine (â†’ +10 unitÃ©s).</div>
        </div></div>
        <div class="row"><div class="lesson grow">
          <h4>ProblÃ¨mes</h4>
          <div class="muted">Mots indices : â€œen toutâ€, â€œau totalâ€ â†’ + ; â€œil resteâ€, â€œperdreâ€ â†’ âˆ’.</div>
        </div>
        <div class="lesson grow">
          <h4>Comparer des nombres</h4>
          <div class="muted">Compare dizaines puis unitÃ©s. 57 &gt; 52 car 7 &gt; 2.</div>
        </div></div>
      </div>
    </div>
  </section>

  <!-- PRÃ‰PA CE2 -->
  <section id="ce2" class="screen">
    <div class="cards">
      <div class="card">
        <h3>PrÃ©pa Ã‰valuations CE2 â€“ FranÃ§ais & Maths</h3>
        <div class="muted">Mode entraÃ®nement ou <b>Examen</b> (timer, sans indices). Score final sur 100 avec feedback.</div>
        <div class="row">
          <label class="muted">Domaine :</label>
          <select id="ce2Domain">
            <option value="mix">Mix (FranÃ§ais & Maths)</option>
            <option value="fr">FranÃ§ais</option>
            <option value="maths">Maths</option>
          </select>
          <label class="muted">Questions :</label>
          <select id="ce2Count">
            <option>10</option><option>12</option><option>15</option>
          </select>
          <div class="row" style="margin-left:auto">
            <div class="muted">Mode Examen</div>
            <div class="toggle" id="ce2Exam"><i></i></div>
            <select id="ce2Timer" title="DurÃ©e">
              <option value="5">5 min</option>
              <option value="8">8 min</option>
              <option value="10" selected>10 min</option>
              <option value="12">12 min</option>
              <option value="15">15 min</option>
            </select>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="ce2Start">DÃ©marrer le test</button>
          <button class="btn ghost" id="ce2Cancel" disabled>Annuler</button>
        </div>
      </div>

      <div class="card" id="ce2TestCard" style="display:none">
        <div class="row">
          <div class="grow">
            <div class="muted">Question <span id="ce2Idx">1</span>/<span id="ce2Total">10</span></div>
            <div class="progress"><i id="ce2Prog"></i></div>
          </div>
          <div class="row">
            <div class="badge" id="ce2Clock">â±ï¸ â€”:â€”</div>
            <div class="badge" id="ce2Mode">ğŸ§ª EntraÃ®nement</div>
          </div>
        </div>

        <div id="ce2Area" class="q" aria-live="polite"></div>

        <div class="row">
          <button class="btn" id="ce2Validate">Valider</button>
          <button class="btn ghost" id="ce2Next" disabled>Suivante âœ</button>
        </div>
      </div>

      <div class="card" id="ce2ResultCard" style="display:none">
        <h3>RÃ©sultats</h3>
        <div class="row">
          <div class="badge">Score : <span id="ce2Score">0</span>/100</div>
          <div class="badge">FranÃ§ais : <span id="ce2ScoreFr">0</span>%</div>
          <div class="badge">Maths : <span id="ce2ScoreMa">0</span>%</div>
        </div>
        <div class="lesson" id="ce2Feedback"></div>
        <div class="row">
          <button class="btn" id="ce2Retry">Refaire un test</button>
          <button class="btn ghost" id="ce2Back">Retour au tableau de bord</button>
        </div>
      </div>

      <div class="card">
        <h3>Historique des tests</h3>
        <ul id="ce2History" class="muted"></ul>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== Helpers & Storage ===== */
const $=(q,r=document)=>r.querySelector(q); const $$=(q,r=document)=>[...r.querySelectorAll(q)];
const say=(t)=>{ try{ const u=new SpeechSynthesisUtterance(t); u.lang='fr-FR'; u.rate=1; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} };
const rng=(a,b)=>Math.floor(Math.random()*(b-a+1))+a; const pick=(arr)=>arr[Math.floor(Math.random()*arr.length)];
const shuffle=(a)=>a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(v=>v[1]);
const store={ get(){try{return JSON.parse(localStorage.getItem('ce1ce2')||'{}')}catch(e){return{}}}, set(d){localStorage.setItem('ce1ce2',JSON.stringify(d))}, patch(p){const d=this.get(); this.set({...d,...p})}, log(e){const d=this.get(); d.log=d.log||[]; d.log.unshift({t:Date.now(),event:e}); d.log=d.log.slice(0,12); this.set(d);} };

/* ===== Global State ===== */
const state={
  name:'AdÃ¨le', autoRead:false, xp:0,
  stats:{fr_conj:{ok:0,total:0}, fr_read:{ok:0,total:0}, fr_ortho:{ok:0,total:0}, m_ops:{ok:0,total:0}, m_pb:{ok:0,total:0}},
  lastTipIndex:0,
  ce2History:[]
};
const tips=[
  "Lis la consigne deux fois, puis regarde les mots importants.",
  "En conjugaison, repÃ¨re dâ€™abord le sujet.",
  "Pour un problÃ¨me, dessine la situation.",
  "Commence toujours par la droite en calcul posÃ©.",
  "Futur proche = aller + infinitif."
];

/* ===== Load / Save ===== */
function loadState(){
  const s=store.get(); Object.assign(state,s);
  $('#childName').value=state.name||'AdÃ¨le'; $('#helloName').textContent=state.name||'AdÃ¨le';
  setToggle($('#autoRead'), !!state.autoRead); renderDashboard(); renderHistory();
}
function saveState(){ store.patch(state); }

/* ===== Tabs ===== */
function switchTab(id){
  $$('.screen').forEach(sc=>sc.classList.remove('active'));
  $$('.tab-btn').forEach(b=>b.classList.remove('active'));
  $('#'+id).classList.add('active'); $(`.tab-btn[data-tab="${id}"]`).classList.add('active');
  if(state.autoRead){ const title={dash:"Tableau de bord",fr:"FranÃ§ais",maths:"Maths",lessons:"LeÃ§ons",ce2:"PrÃ©pa CE2"}[id]; say(title); }
}
$$('.tab-btn').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));
$$('[data-tab-jump]').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tabJump)));

$('#saveName').addEventListener('click',()=>{ state.name=$('#childName').value.trim()||'AdÃ¨le'; $('#helloName').textContent=state.name; saveState(); renderDashboard(); });
$('#speakConsigne').addEventListener('click',()=>{ const active=$('.screen.active'); const label=active?active.querySelector('h3')?.textContent||'ActivitÃ©':'ActivitÃ©'; say(`Consigne : ${label}.`); });
function setToggle(el,on){ el.classList.toggle('on',!!on); }
$('#autoRead').addEventListener('click',()=>{ state.autoRead=!state.autoRead; setToggle($('#autoRead'),state.autoRead); saveState(); if(state.autoRead) say("Lecture des consignes activÃ©e."); });

/* ===== Dashboard / XP ===== */
function addXP(n){ state.xp=Math.min(100,(state.xp||0)+n); saveState(); renderDashboard(); }
function pushStat(key,ok){ const s=state.stats[key]; s.total++; if(ok) s.ok++; saveState(); renderDashboard(); }
function renderDashboard(){
  $('#xpbar').style.width=(state.xp||0)+'%'; $('#xpText').textContent=state.xp||0;
  const statsList=$('#statsList'); statsList.innerHTML='';
  for(const [k,s] of Object.entries(state.stats)){
    const label={fr_conj:'FranÃ§ais â€“ Conjugaison',fr_read:'FranÃ§ais â€“ ComprÃ©hension',fr_ortho:'FranÃ§ais â€“ Orthographe',m_ops:'Maths â€“ OpÃ©rations',m_pb:'Maths â€“ ProblÃ¨mes'}[k];
    const li=document.createElement('li'); li.textContent=`${label}: ${s.ok}/${s.total}`; statsList.appendChild(li);
  }
  const kudos=$('#kudos'); kudos.innerHTML=''; const stars=Math.floor((state.xp||0)/20);
  for(let i=0;i<5;i++){ const box=document.createElement('i'); box.textContent=i<stars?'â­':'â˜†'; kudos.appendChild(box); }
  $('#tip').textContent=tips[state.lastTipIndex % tips.length];
  const log=store.get().log||[]; const ul=$('#activityLog'); ul.innerHTML='';
  log.forEach(l=>{ const li=document.createElement('li'); const d=new Date(l.t); li.textContent=`${d.toLocaleString('fr-FR')} â€“ ${l.event}`; ul.appendChild(li); });
}
$('#resetProgress').addEventListener('click',()=>{ if(confirm("RÃ©initialiser la progression (XP + stats + historique CE2) ?")){ state.xp=0; state.stats={fr_conj:{ok:0,total:0}, fr_read:{ok:0,total:0}, fr_ortho:{ok:0,total:0}, m_ops:{ok:0,total:0}, m_pb:{ok:0,total:0}}; state.ce2History=[]; store.patch({xp:0,stats:state.stats,log:[],ce2History:[]}); renderDashboard(); renderHistory(); }});
$('#downloadReport').addEventListener('click',()=>{ const data=store.get(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`revisions-ce1ce2-${(state.name||'eleve').toLowerCase()}.json`; a.click(); });

/* ===== FR â€“ Conjugaison ===== */
const verbs={ parler:["parle","parles","parle","parlons","parlez","parlent"], jouer:["joue","joues","joue","jouons","jouez","jouent"], chanter:["chante","chantes","chante","chantons","chantez","chantent"], manger:["mange","manges","mange","mangeons","mangez","mangent"], aimer:["aime","aimes","aime","aimons","aimez","aiment"], Ãªtre:["suis","es","est","sommes","Ãªtes","sont"], avoir:["ai","as","a","avons","avez","ont"], aller:["vais","vas","va","allons","allez","vont"], faire:["fais","fais","fait","faisons","faites","font"] };
const subjects=["je","tu","il/elle","nous","vous","ils/elles"];
function populateConjSelectors(){ const vs=$('#verbSelect'); vs.innerHTML=''; Object.keys(verbs).forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; vs.appendChild(o); }); const ss=$('#subjectSelect'); ss.innerHTML=''; subjects.forEach((s,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=s; ss.appendChild(o); }); }
populateConjSelectors();
let currentConj=null;
function newConjugation(){ const v=$('#verbSelect').value||pick(Object.keys(verbs)); const si=Number($('#subjectSelect').value??rng(0,5)); currentConj={v,si}; const subj=subjects[si]; $('#conjPrompt').textContent=`Conjugue au prÃ©sent : ${subj} â€¦ ${v}`; $('#conjAnswer').value=''; $('#conjFeedback').textContent=''; if(state.autoRead) say(`Conjugue : ${subj} ${v}`); }
$('#newConj').addEventListener('click',newConjugation);
$('#checkConj').addEventListener('click',()=>{ if(!currentConj){ newConjugation(); return; } const correct=verbs[currentConj.v][currentConj.si]; const ans=$('#conjAnswer').value.trim().toLowerCase(); if(ans===correct){ $('#conjFeedback').innerHTML=`<span class="badge">âœ… Bravo ! <b>${subjects[currentConj.si]} ${correct}</b></span>`; pushStat('fr_conj',true); addXP(2); store.log('fr_conj_ok'); state.lastTipIndex++; saveState(); } else { $('#conjFeedback').innerHTML=`âŒ RÃ©ponse attendue : <b>${subjects[currentConj.si]} ${correct}</b>`; pushStat('fr_conj',false); store.log('fr_conj_ko'); } });
$('#conjHint').addEventListener('click',()=>{ if(!currentConj) return; const endings=["-e","-es","-e","-ons","-ez","-ent"]; const v=currentConj.v; if(["Ãªtre","avoir","aller","faire"].includes(v)){ $('#conjFeedback').textContent="Verbe trÃ¨s courant : essaie de le rÃ©citer dans ta tÃªte."; } else { $('#conjFeedback').textContent=`Indice : terminaisons des verbes en -er au prÃ©sent : ${endings.join(", ")}.`; } });

/* ===== FR â€“ ComprÃ©hension ===== */
const readings=[ { text:"LÃ©a a trouvÃ© une petite plume bleue dans le jardin. Elle la pose dans son cahier et montre sa dÃ©couverte Ã  son frÃ¨re. Ils sourient.", qs:[ {q:"Qui a trouvÃ© la plume ?",choices:["LÃ©a","Son frÃ¨re","Le voisin"],a:0}, {q:"De quelle couleur est la plume ?",choices:["Rouge","Bleue","Verte"],a:1}, {q:"Que fait LÃ©a avec la plume ?",choices:["Elle la jette","Elle la pose dans son cahier","Elle la perd"],a:1} ] },
{ text:"Dans la cour de lâ€™Ã©cole, Tom observe les nuages. Lâ€™un ressemble Ã  un bateau, un autre Ã  un lapin. La cloche sonne et Tom rentre en classe.", qs:[ {q:"OÃ¹ est Tom ?",choices:["Ã€ la maison","Dans la cour de lâ€™Ã©cole","Au parc"],a:1}, {q:"Ã€ quoi ressemble un nuage ?",choices:["Ã€ une voiture","Ã€ un bateau","Ã€ une maison"],a:1}, {q:"Que se passe-t-il Ã  la fin ?",choices:["Il pleut","La cloche sonne","Tom sâ€™endort"],a:1} ] },
{ text:"Mina arrose la plante de la fenÃªtre tous les matins. Aujourdâ€™hui, une petite fleur blanche est apparue. Mina est fiÃ¨re dâ€™elle.", qs:[ {q:"Que fait Mina tous les matins ?",choices:["Elle danse","Elle arrose la plante","Elle lit un livre"],a:1}, {q:"De quelle couleur est la fleur ?",choices:["Jaune","Blanche","Bleue"],a:1}, {q:"Comment se sent Mina ?",choices:["Triste","FÃ¢chÃ©e","FiÃ¨re"],a:2} ] } ];
let currentRead=null, readIndex=-1, readScore=0;
function newReading(){ readIndex=(readIndex+1)%readings.length; currentRead=readings[readIndex]; $('#readingText').textContent=currentRead.text; $('#readingChoices').innerHTML=''; $('#readingFeedback').textContent=''; readScore=0; currentRead.qs.forEach((item,idx)=>{ const block=document.createElement('div'); block.className='lesson'; const title=document.createElement('div'); title.innerHTML=`<b>${idx+1}.</b> ${item.q}`; const choices=document.createElement('div'); choices.className='choices'; shuffle(item.choices.map((c,i)=>({c,i}))).forEach(entry=>{ const btn=document.createElement('div'); btn.className='choice'; btn.textContent=entry.c; btn.addEventListener('click',()=>{ const correctIdx=item.a; const isCorrect=item.choices[correctIdx]===entry.c; btn.classList.add(isCorrect?'correct':'wrong'); [...choices.children].forEach(ch=>ch.style.pointerEvents='none'); if(isCorrect){ readScore++; addXP(1); store.log('fr_read_q_ok'); }else{ store.log('fr_read_q_ko'); } if(readScore===currentRead.qs.length){ $('#readingFeedback').innerHTML=`<span class="badge">ğŸ‰ Parfait !</span>`; pushStat('fr_read',true); } else if([...$('.choices',block).children].every(c=>c.style.pointerEvents==='none')){ if(idx===currentRead.qs.length-1){ pushStat('fr_read', readScore===currentRead.qs.length); } } }); choices.appendChild(btn); }); block.appendChild(title); block.appendChild(choices); $('#readingChoices').appendChild(block); }); if(state.autoRead) say("Lis le texte puis rÃ©ponds aux questions."); }
$('#newReading').addEventListener('click',newReading);
$('#readingHint').addEventListener('click',()=>{ const sentence="RepÃ¨re les mots importants : personnages, lieux, actions."; $('#readingFeedback').textContent=sentence; if(state.autoRead) say(sentence); });

/* ===== FR â€“ Ortho ===== */
const orthoPairs=[ {prompt:"Choisis la bonne phrase :",opts:["Les chats noirs jouent.","Les chat noir jouent."],a:0},
{prompt:"Choisis la bonne phrase :",opts:["La petite fille est contente.","La petite fille est contents."],a:0},
{prompt:"Choisis la bonne phrase :",opts:["Nous allons Ã  lâ€™Ã©cole.","Nous allait Ã  lâ€™Ã©cole."],a:0},
{prompt:"Choisis la bonne phrase :",opts:["Ils ont un ballon rouge.","Ils a un ballon rouge."],a:0},
{prompt:"Choisis la bonne phrase :",opts:["Le garÃ§on est heureux.","Le garÃ§on est heureuse."],a:0} ];
let currentOrtho=null;
function newOrtho(){ currentOrtho=pick(orthoPairs); $('#orthoPrompt').textContent=currentOrtho.prompt; const zone=$('#orthoChoices'); zone.innerHTML=''; shuffle(currentOrtho.opts.map((c,i)=>({c,i}))).forEach(entry=>{ const div=document.createElement('div'); div.className='choice'; div.textContent=entry.c; div.addEventListener('click',()=>{ const isCorrect=currentOrtho.opts[currentOrtho.a]===entry.c; div.classList.add(isCorrect?'correct':'wrong'); [...zone.children].forEach(ch=>ch.style.pointerEvents='none'); $('#orthoFeedback').textContent=isCorrect?"âœ… Bien vu !":"âŒ Regarde lâ€™accord du nom et de lâ€™adjectif."; pushStat('fr_ortho',isCorrect); if(isCorrect) addXP(1); store.log(isCorrect?'fr_ortho_ok':'fr_ortho_ko'); }); zone.appendChild(div); }); $('#orthoFeedback').textContent=''; if(state.autoRead) say("Lis bien et choisis la phrase correcte."); }
$('#newOrtho').addEventListener('click',newOrtho);

/* ===== Maths â€“ OpÃ©rations ===== */
let currentOp=null;
function genOp(){ const typ=$('#opType').value; const lvl=Number($('#level').value); const cap=lvl===1?20:lvl===2?50:99; let a=rng(0,cap), b=rng(0,cap); if(typ==='-'&&b>a){[a,b]=[b,a]} currentOp={a,b,typ}; $('#opPrompt').textContent=`${a} ${typ} ${b} = ?`; $('#opAnswer').value=''; $('#opFeedback').textContent=''; if(state.autoRead) say(`Calcule ${a} ${typ} ${b}`); }
$('#newOp').addEventListener('click',genOp);
$('#checkOp').addEventListener('click',()=>{ if(!currentOp) return; const {a,b,typ}=currentOp; const correct=typ==='+'?a+b:a-b; const ans=Number($('#opAnswer').value); if(ans===correct){ $('#opFeedback').innerHTML=`<span class="badge">âœ… Exact, ${a} ${typ} ${b} = ${correct}</span>`; pushStat('m_ops',true); addXP(2); store.log('m_ops_ok'); } else { $('#opFeedback').innerHTML=`âŒ Pas tout Ã  fait. La bonne rÃ©ponse est <b>${correct}</b>.`; pushStat('m_ops',false); store.log('m_ops_ko'); } });
$('#opHint').addEventListener('click',()=>{ if(!currentOp) return; const {a,b,typ}=currentOp; const msg=typ==='+'?`Commence par les unitÃ©s : ${a%10} + ${b%10}. Y a-t-il une retenue ?`:`Commence par les unitÃ©s : ${a%10} âˆ’ ${b%10}. Si tu ne peux pas, emprunte 1 dizaine.`; $('#opFeedback').textContent=msg; if(state.autoRead) say(msg); });

/* ===== Maths â€“ ProblÃ¨mes ===== */
const pbModels=[ (a,b)=>({txt:`Dans une boÃ®te, il y a ${a} billes. On en ajoute ${b}. Combien y a-t-il de billes en tout ?`,op:"+",res:a+b,steps:[`On cherche le total â†’ addition.`,`${a} + ${b} = ${a+b}.`,`RÃ©ponse : ${a+b} billes.`]}),
(a,b)=>({txt:`Emma lit ${a} pages le matin et ${b} pages lâ€™aprÃ¨s-midi. Combien de pages a-t-elle lues aujourdâ€™hui ?`,op:"+",res:a+b,steps:[`Total dans la journÃ©e.`,`${a} + ${b} = ${a+b}.`,`RÃ©ponse : ${a+b} pages.`]}),
(a,b)=>({txt:`LÃ©o a ${a} autocollants. Il en donne ${b} Ã  sa sÅ“ur. Combien lui en reste-t-il ?`,op:"-",res:a-b,steps:[`Mot indice â€œil resteâ€ â†’ soustraction.`,`${a} âˆ’ ${b} = ${a-b}.`,`RÃ©ponse : ${a-b}.`]}),
(a,b)=>({txt:`Il y a ${a} oiseaux sur la branche. ${b} sâ€™envolent. Combien dâ€™oiseaux restent sur la branche ?`,op:"-",res:a-b,steps:[`Des oiseaux partent â†’ on enlÃ¨ve.`,`${a} âˆ’ ${b} = ${a-b}.`,`RÃ©ponse : ${a-b}.`]}) ];
let currentPb=null;
function newPb(){ let a=rng(6,30), b=rng(2,15); if(Math.random()<.5&&b>a)[a,b]=[b,a]; const model=pick(pbModels); const pb=model(a,b); currentPb=pb; $('#pbText').textContent=pb.txt; $('#pbSteps').textContent=''; $('#pbOpChoice').value=''; $('#pbAnswer').value=''; if(state.autoRead) say("Lis le problÃ¨me. Choisis lâ€™opÃ©ration, puis calcule."); }
$('#newPb').addEventListener('click',newPb);
$('#pbHint').addEventListener('click',()=>{ if(!currentPb) return; const msg=currentPb.op==='+'?"Cherche â€œen toutâ€, â€œau totalâ€â€¦":"Cherche â€œil resteâ€, â€œpartirâ€â€¦"; $('#pbSteps').textContent=msg; if(state.autoRead) say(msg); });
$('#checkPb').addEventListener('click',()=>{ if(!currentPb) return; const chosen=$('#pbOpChoice').value; const ans=Number($('#pbAnswer').value); const okOp=chosen===currentPb.op; const okRes=ans===currentPb.res; const steps=currentPb.steps.map((s,i)=>`${i+1}. ${s}`).join('\n'); $('#pbSteps').innerHTML=`<pre style="white-space:pre-wrap;margin:0">${steps}</pre>`; const success=okOp&&okRes; pushStat('m_pb',success); store.log(success?'m_pb_ok':'m_pb_ko'); if(success) addXP(3); });

/* ===== CE2 Prep â€“ Test Engine ===== */
// Bank: lightweight CE2-style items (MCQ & input)
const ce2Bank={
  fr:[
    // comprÃ©hension courte (texte + 1 question)
    {type:'read', text:"Nora range ses crayons par couleur. Elle commence par les bleus puis les verts.", q:"Que fait Nora dâ€™abord ?", choices:["Elle range les verts","Elle commence par les bleus","Elle ne range pas"], a:1, weight:1},
    {type:'read', text:"Au marchÃ©, Paul achÃ¨te deux pommes et un pain. Il sourit au boulanger.", q:"OÃ¹ est Paul ?", choices:["Ã€ lâ€™Ã©cole","Au marchÃ©","Au parc"], a:1, weight:1},
    // grammaire / orthographe
    {type:'mcq', q:"Choisis la phrase correcte :", choices:["Les oiseaux chante.","Les oiseaux chantent."], a:1, weight:1},
    {type:'mcq', q:"Accord dÃ©terminant-nom :", choices:["La vÃ©los rouge","Le vÃ©lo rouge","Les vÃ©lo rouge"], a:1, weight:1},
    // conjugaison prÃ©sent (MCQ)
    {type:'mcq', q:"Conjugue au prÃ©sent : nous â€¦ (manger)", choices:["mangeons","mangeants","mange"], a:0, weight:1},
    {type:'mcq', q:"Conjugue au prÃ©sent : ils â€¦ (aller)", choices:["allons","allez","vont"], a:2, weight:1}
  ],
  maths:[
    // opÃ©rations
    {type:'calc', q:"13 + 9 = ?", answer:22, weight:1},
    {type:'calc', q:"47 âˆ’ 18 = ?", answer:29, weight:1},
    {type:'calc', q:"25 + 7 = ?", answer:32, weight:1},
    // problÃ¨mes courts
    {type:'word', txt:a=>`Il y a ${a} cartes. On en ajoute 5. Combien en tout ?`, make:()=>{const a=rng(8,20); return {q:`Il y a ${a} cartes. On en ajoute 5.`, res:a+5};}, weight:1},
    {type:'word', txt:a=>`Lina a ${a} billes et en perd 4. Combien lui reste-t-il ?`, make:()=>{const a=rng(9,20); return {q:`Lina a ${a} billes et en perd 4.`, res:a-4};}, weight:1}
  ]
};

// Test runtime
let ce2Run=null, ce2TimerId=null;
function buildTest(domain,count){
  const items=[];
  const add=(arr,n)=>{ const pool=shuffle(arr.slice()); for(let i=0;i<Math.min(n,pool.length);i++) items.push(pool[i]); };
  if(domain==='fr'){ add(ce2Bank.fr, count); }
  else if(domain==='maths'){ add(ce2Bank.maths, count); }
  else {
    // mix: 50/50 arrondi
    const half=Math.floor(count/2); add(ce2Bank.fr, half); add(ce2Bank.maths, count-half);
  }
  // expand generated "word" items
  const expanded = items.flatMap(it=>{
    if(it.type==='word'){ const made=it.make(); return [{type:'calcWord', q:made.q, answer:made.res, weight:it.weight}]; }
    return [it];
  });
  return shuffle(expanded);
}

function renderHistory(){
  const ul=$('#ce2History'); ul.innerHTML='';
  (state.ce2History||[]).forEach(h=>{
    const li=document.createElement('li');
    const d=new Date(h.t);
    li.textContent=`${d.toLocaleString('fr-FR')} â€“ ${h.mode} â€“ ${h.domain} â€“ ${h.score}/100 (Fr ${h.fr}%, Ma ${h.ma}%)`;
    ul.appendChild(li);
  });
}

function startCe2(){
  const domain=$('#ce2Domain').value;
  const count=parseInt($('#ce2Count').value,10);
  const exam=$('#ce2Exam').classList.contains('on');
  const minutes=parseInt($('#ce2Timer').value,10);
  ce2Run={
    domain, total:count, idx:0, answered:false, exam,
    tLeft: minutes*60, // seconds
    items: buildTest(domain,count),
    score:0, fr:{ok:0,total:0}, ma:{ok:0,total:0}
  };
  $('#ce2Total').textContent=count; $('#ce2Idx').textContent=1;
  $('#ce2Mode').textContent=exam?'ğŸ§ª Examen':'ğŸ§ª EntraÃ®nement';
  $('#ce2Prog').style.width='0%';
  $('#ce2ResultCard').style.display='none';
  $('#ce2TestCard').style.display='';
  $('#ce2Start').disabled=true; $('#ce2Cancel').disabled=false;
  $('#ce2Next').disabled=true;
  renderCe2Item();
  if(exam){ runTimer(); } else { $('#ce2Clock').textContent='â±ï¸ â€”:â€”'; }
}
function cancelCe2(){ clearInterval(ce2TimerId); ce2TimerId=null; ce2Run=null; $('#ce2TestCard').style.display='none'; $('#ce2Start').disabled=false; $('#ce2Cancel').disabled=true; }
function runTimer(){
  clearInterval(ce2TimerId);
  const tick=()=>{ if(!ce2Run) return; ce2Run.tLeft--; const m=Math.floor(ce2Run.tLeft/60), s=ce2Run.tLeft%60; $('#ce2Clock').textContent=`â±ï¸ ${m}:${String(s).padStart(2,'0')}`; if(ce2Run.tLeft<=0){ clearInterval(ce2TimerId); finishCe2(true); } };
  tick(); ce2TimerId=setInterval(tick,1000);
}

function renderCe2Item(){
  const it=ce2Run.items[ce2Run.idx];
  const area=$('#ce2Area'); area.innerHTML='';
  if(it.type==='read'){
    const text=document.createElement('div'); text.className='lesson'; text.textContent=it.text; area.appendChild(text);
    const title=document.createElement('div'); title.className='title'; title.textContent=it.q; area.appendChild(title);
    const box=document.createElement('div'); box.className='choices';
    shuffle(it.choices.map((c,i)=>({c,i}))).forEach(ch=>{
      const div=document.createElement('div'); div.className='choice'; div.textContent=ch.c;
      div.addEventListener('click',()=>{ if(ce2Run.answered) return; ce2Run.answered=true;
        const correct=it.choices[it.a]===ch.c; markResult(div,correct,box); tally('fr',correct,it.weight); });
      box.appendChild(div);
    }); area.appendChild(box);
  } else if(it.type==='mcq'){
    const title=document.createElement('div'); title.className='title'; title.textContent=it.q; area.appendChild(title);
    const box=document.createElement('div'); box.className='choices';
    shuffle(it.choices.map((c,i)=>({c,i}))).forEach(ch=>{
      const div=document.createElement('div'); div.className='choice'; div.textContent=ch.c;
      div.addEventListener('click',()=>{ if(ce2Run.answered) return; ce2Run.answered=true;
        const correct=it.choices[it.a]===ch.c; markResult(div,correct,box); tally('fr',correct,it.weight); });
      box.appendChild(div);
    }); area.appendChild(box);
  } else if(it.type==='calc'){
    const title=document.createElement('div'); title.className='title'; title.textContent=it.q; area.appendChild(title);
    const row=document.createElement('div'); row.className='row';
    const input=document.createElement('input'); input.type='number'; input.placeholder='RÃ©ponse'; input.id='ce2Input';
    row.appendChild(input); area.appendChild(title); area.appendChild(row);
  } else if(it.type==='calcWord'){
    const text=document.createElement('div'); text.className='lesson'; text.textContent=it.q; area.appendChild(text);
    const row=document.createElement('div'); row.className='row';
    const input=document.createElement('input'); input.type='number'; input.placeholder='RÃ©sultat'; input.id='ce2Input';
    row.appendChild(input); area.appendChild(row);
  }
  ce2Run.answered=false;
}
function markResult(div,correct,box){
  div.classList.add(correct?'correct':'wrong'); [...box.children].forEach(c=>c.style.pointerEvents='none');
  if(!ce2Run.exam){ // petit feedback visuel seulement en entraÃ®nement
    const note=document.createElement('div'); note.className='muted'; note.textContent=correct?'âœ… Bien jouÃ© !':'âŒ Regarde bien la consigne.'; $('#ce2Area').appendChild(note);
  }
}
function tally(domain,correct,weight){
  if(domain==='fr') ce2Run.fr.total+=weight; else ce2Run.ma.total+=weight;
  if(correct){ if(domain==='fr') ce2Run.fr.ok+=weight; else ce2Run.ma.ok+=weight; ce2Run.score += Math.round(100/ce2Run.total); addXP(2); }
}
function validateCe2(){
  if(ce2Run.answered){ $('#ce2Next').disabled=false; return; }
  // for input questions
  const it=ce2Run.items[ce2Run.idx];
  if(it.type==='calc'||it.type==='calcWord'){
    const val=Number($('#ce2Input')?.value);
    const correct=(val===it.answer);
    if(!ce2Run.exam){
      const fb=document.createElement('div'); fb.className='muted'; fb.textContent=correct?`âœ… Correct`:`âŒ RÃ©ponse : ${it.answer}`; $('#ce2Area').appendChild(fb);
    }
    tally('maths',correct,it.weight);
    ce2Run.answered=true;
    $('#ce2Next').disabled=false;
  } else {
    // MCQ not clicked
    if(!ce2Run.exam){ const fb=document.createElement('div'); fb.className='muted'; fb.textContent="Choisis une rÃ©ponse pour continuer."; $('#ce2Area').appendChild(fb); }
  }
}
function nextCe2(){
  ce2Run.idx++;
  const pct=Math.round((ce2Run.idx/ce2Run.total)*100); $('#ce2Prog').style.width=pct+'%';
  if(ce2Run.idx>=ce2Run.total){ finishCe2(false); return; }
  $('#ce2Idx').textContent=ce2Run.idx+1; $('#ce2Next').disabled=true; renderCe2Item();
}
function finishCe2(timeout){
  clearInterval(ce2TimerId); ce2TimerId=null;
  $('#ce2TestCard').style.display='none';
  // compute breakdown %
  const frPct = ce2Run.fr.total ? Math.round(100*ce2Run.fr.ok/ce2Run.fr.total) : (ce2Run.domain==='maths'?0:100);
  const maPct = ce2Run.ma.total ? Math.round(100*ce2Run.ma.ok/ce2Run.ma.total) : (ce2Run.domain==='fr'?0:100);
  const score=Math.max(0, Math.min(100, Math.round((frPct+maPct)/2))); // lisible
  $('#ce2Score').textContent=score; $('#ce2ScoreFr').textContent=frPct; $('#ce2ScoreMa').textContent=maPct;
  const tips=[];
  if(frPct<70) tips.push("ğŸ“– Renforcer : comprÃ©hension de texte (repÃ©rer personnages/lieux/actions) et accords simples.");
  if(maPct<70) tips.push("â— RÃ©viser : additions/soustractions posÃ©es et mots-indices des problÃ¨mes.");
  if(score>=85) tips.unshift("ğŸ‰ Excellent niveau, prÃªtÂ·e pour lâ€™Ã©val !");
  else if(score>=70) tips.unshift("ğŸ‘ Bon niveau : encore un peu dâ€™entraÃ®nement ciblÃ©.");
  else tips.unshift("ğŸš€ On sâ€™accroche : petits entraÃ®nements courts et rÃ©guliers.");
  if(timeout) tips.push("â±ï¸ Gestion du temps : lis la question entiÃ¨re avant de rÃ©pondre.");
  $('#ce2Feedback').innerHTML=tips.map(t=>`<div>â€¢ ${t}</div>`).join('');
  $('#ce2ResultCard').style.display='';
  // history
  const entry={t:Date.now(), mode:ce2Run.exam?'Examen':'EntraÃ®nement', domain:ce2Run.domain, score, fr:frPct, ma:maPct};
  state.ce2History = [entry, ...(state.ce2History||[])].slice(0,15);
  store.patch({ce2History:state.ce2History}); renderHistory();
  store.log(`ce2_${ce2Run.exam?'exam':'train'}_${ce2Run.domain}_${score}`);
  addXP(score>=70?5:2);
  ce2Run=null; $('#ce2Start').disabled=false; $('#ce2Cancel').disabled=true;
}
$('#ce2Start').addEventListener('click',startCe2);
$('#ce2Cancel').addEventListener('click',cancelCe2);
$('#ce2Validate').addEventListener('click',validateCe2);
$('#ce2Next').addEventListener('click',nextCe2);
$('#ce2Retry').addEventListener('click',()=>{ $('#ce2ResultCard').style.display='none'; startCe2(); });
$('#ce2Back').addEventListener('click',()=>switchTab('dash'));
$('#ce2Exam').addEventListener('click',()=>setToggle($('#ce2Exam'), !$('#ce2Exam').classList.contains('on')));

/* ===== Boot ===== */
window.addEventListener('load',()=>{
  loadState();
  // init activities
  newConjugation(); newReading(); newOrtho(); genOp(); newPb();
});
</script>
</body>
</html>
